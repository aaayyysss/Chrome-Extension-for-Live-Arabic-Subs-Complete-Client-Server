<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Arabic Subs v1.1.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 360px;
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      max-height: 600px;
      overflow-y: auto;
    }

    .popup-container {
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 15px;
    }

    .logo svg {
      color: #3b82f6;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #6b7280;
    }

    .status-indicator.active {
      background: #ef4444;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .settings-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #9ca3af;
    }

    .setting-row {
      margin-bottom: 16px;
    }

    .setting-row:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 8px;
      color: #d1d5db;
    }

    select, input {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .main-control {
      text-align: center;
      margin: 24px 0;
    }

    .capture-btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .capture-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .capture-btn.recording {
      background: #ef4444;
    }

    .capture-btn.recording:hover {
      background: #dc2626;
    }

    .hidden {
      display: none !important;
    }

    .footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 12px;
      color: #9ca3af;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      color: #fecaca;
      font-size: 13px;
    }

    .success-message {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      color: #bbf7d0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="popup-container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="20" height="16" rx="2"/>
          <path d="M7 15h4M13 15h4M7 11h10"/>
        </svg>
        <div>
          <span>Live Arabic Subs</span>
          <div style="font-size: 11px; color: #9ca3af;">v1.1.0</div>
        </div>
      </div>
      <div id="status-indicator" class="status-indicator"></div>
    </header>

    <!-- Status Messages -->
    <div id="status-messages"></div>

    <!-- Backend Configuration -->
    <div class="settings-section">
      <h3 class="section-title">Backend Server</h3>
      
      <div class="setting-row">
        <label>Server</label>
        <select id="backend-selector">
          <option value="local">üè† Local Server (localhost:8002)</option>
          <option value="external">‚òÅÔ∏è EmergentAgent Cloud</option>
        </select>
      </div>

      <button id="test-connection" style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">
        Test Connection
      </button>
    </div>

    <!-- Main Control -->
    <div class="main-control">
      <button id="capture-btn" class="capture-btn">
        <svg id="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        <svg id="stop-icon" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="6" y="6" width="12" height="12"/>
        </svg>
        <span id="capture-text">Start Capture</span>
      </button>
    </div>

    <!-- Language Settings -->
    <div class="settings-section">
      <h3 class="section-title">Languages</h3>
      
      <div class="setting-row">
        <label>Source Language</label>
        <select id="source-language">
          <option value="">Auto-detect</option>
          <option value="en">üá∫üá∏ English</option>
          <option value="es">üá™üá∏ Spanish</option>
          <option value="fr">üá´üá∑ French</option>
          <option value="de">üá©üá™ German</option>
        </select>
      </div>

      <div class="setting-row">
        <label>Output Language</label>
        <select id="output-language">
          <option value="ar" selected>üá∏üá¶ Arabic (Modern Standard)</option>
        </select>
      </div>
    </div>

    <!-- API Configuration -->
    <div class="settings-section">
      <h3 class="section-title">API Configuration</h3>
      
      <div class="setting-row">
        <label>Provider</label>
        <select id="api-provider">
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic Claude</option>
        </select>
      </div>

      <div class="setting-row">
        <label>API Key</label>
        <input type="password" id="api-key" placeholder="Enter your API key">
        <button id="save-api-key" style="width: 100%; margin-top: 8px; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save API Key
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Local server ready on port 8002
    </div>
  </div>

  <script>
    // Simplified popup script with error handling
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Enhanced popup loaded');
      
      // DOM Elements
      const statusMessages = document.getElementById('status-messages');
      const statusIndicator = document.getElementById('status-indicator');
      const captureBtn = document.getElementById('capture-btn');
      const captureText = document.getElementById('capture-text');
      const micIcon = document.getElementById('mic-icon');
      const stopIcon = document.getElementById('stop-icon');
      const testConnectionBtn = document.getElementById('test-connection');
      const saveApiKeyBtn = document.getElementById('save-api-key');
      
      // State
      let isCapturing = false;
      let settings = {
        backend: 'local',
        sourceLanguage: '',
        outputLanguage: 'ar',
        apiProvider: 'openai',
        apiKey: ''
      };

      // Show status message
      function showStatus(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `${type}-message`;
        messageDiv.textContent = message;
        statusMessages.appendChild(messageDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
          }
        }, 5000);
      }

      // Update capture button state
      function updateCaptureButton() {
        if (isCapturing) {
          captureBtn.classList.add('recording');
          captureText.textContent = 'Stop Capture';
          micIcon.classList.add('hidden');
          stopIcon.classList.remove('hidden');
          statusIndicator.classList.add('active');
        } else {
          captureBtn.classList.remove('recording');
          captureText.textContent = 'Start Capture';
          micIcon.classList.remove('hidden');
          stopIcon.classList.add('hidden');
          statusIndicator.classList.remove('active');
        }
      }

      // Test connection to backend
      async function testConnection() {
        try {
          testConnectionBtn.disabled = true;
          testConnectionBtn.textContent = 'Testing...';
          
          const backend = document.getElementById('backend-selector').value;
          let url;
          
          if (backend === 'local') {
            url = 'http://localhost:8002/health';
          } else {
            url = 'https://live-arabic-subs.preview.emergentagent.com/api/';
          }
          
          const response = await fetch(url, { method: 'GET', mode: 'cors' });
          
          if (response.ok) {
            showStatus(`‚úÖ Connected to ${backend} server`, 'success');
          } else {
            throw new Error(`Server responded with status ${response.status}`);
          }
        } catch (error) {
          showStatus(`‚ùå Connection failed: ${error.message}`, 'error');
        } finally {
          testConnectionBtn.disabled = false;
          testConnectionBtn.textContent = 'Test Connection';
        }
      }

      // Handle capture toggle
      function handleCaptureToggle() {
        if (isCapturing) {
          // Stop capture
          chrome.runtime.sendMessage({ type: 'STOP_CAPTURE' }, (response) => {
            if (chrome.runtime.lastError) {
              showStatus(`‚ùå Error: ${chrome.runtime.lastError.message}`, 'error');
            } else if (response?.success) {
              isCapturing = false;
              updateCaptureButton();
              showStatus('‚èπÔ∏è Capture stopped', 'success');
            } else {
              showStatus('‚ùå Failed to stop capture', 'error');
            }
          });
        } else {
          // Start capture - check API key first
          const apiKey = document.getElementById('api-key').value;
          if (!apiKey) {
            showStatus('‚ö†Ô∏è Please enter an API key first', 'error');
            return;
          }
          
          chrome.runtime.sendMessage({ type: 'START_CAPTURE' }, (response) => {
            if (chrome.runtime.lastError) {
              showStatus(`‚ùå Error: ${chrome.runtime.lastError.message}`, 'error');
            } else if (response?.success) {
              isCapturing = true;
              updateCaptureButton();
              showStatus('üé§ Capture started', 'success');
            } else {
              showStatus('‚ùå Failed to start capture', 'error');
            }
          });
        }
      }

      // Save API key
      function saveApiKey() {
        const apiKey = document.getElementById('api-key').value;
        const provider = document.getElementById('api-provider').value;
        
        if (!apiKey) {
          showStatus('‚ö†Ô∏è Please enter an API key', 'error');
          return;
        }
        
        // Save to chrome storage
        chrome.storage.sync.set({ 
          lasApiKey: apiKey,
          lasApiProvider: provider 
        }, () => {
          if (chrome.runtime.lastError) {
            showStatus(`‚ùå Error saving key: ${chrome.runtime.lastError.message}`, 'error');
          } else {
            showStatus('‚úÖ API key saved successfully', 'success');
          }
        });
      }

      // Load saved settings
      function loadSettings() {
        chrome.storage.sync.get(['lasApiKey', 'lasApiProvider'], (result) => {
          if (result.lasApiKey) {
            document.getElementById('api-key').value = result.lasApiKey;
          }
          if (result.lasApiProvider) {
            document.getElementById('api-provider').value = result.lasApiProvider;
          }
        });
      }

      // Event listeners
      testConnectionBtn.addEventListener('click', testConnection);
      captureBtn.addEventListener('click', handleCaptureToggle);
      saveApiKeyBtn.addEventListener('click', saveApiKey);

      // Initialize
      loadSettings();
      showStatus('‚úÖ Extension loaded successfully', 'success');
      console.log('Popup initialization complete');
    });
  </script>
</body>
</html>